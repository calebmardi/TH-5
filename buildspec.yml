version: 0.2

# AWS CodeBuild buildspec para DataVision App
# IntegraciÃ³n continua con GitHub + CodePipeline + CodeDeploy

phases:
  install:
    runtime-versions:
      nodejs: 18
    commands:
      - echo "ğŸš€ Iniciando fase de instalaciÃ³n..."
      - echo "ğŸ“¦ Instalando dependencias de Node.js"
      - npm install
      - echo "ğŸ³ Verificando Docker (si estÃ¡ disponible)"
      - docker --version || echo "Docker no disponible en CodeBuild"
      
  pre_build:
    commands:
      - echo "ğŸ” Ejecutando validaciones pre-build..."
      - echo "ğŸ“‹ Verificando estructura del proyecto"
      - ls -la
      - echo "âœ… Verificando archivos crÃ­ticos"
      - test -f appspec.yml && echo "âœ“ appspec.yml encontrado" || (echo "âŒ appspec.yml faltante" && exit 1)
      - test -f app.js && echo "âœ“ app.js encontrado" || (echo "âŒ app.js faltante" && exit 1)
      - test -f package.json && echo "âœ“ package.json encontrado" || (echo "âŒ package.json faltante" && exit 1)
      - test -d scripts && echo "âœ“ directorio scripts encontrado" || (echo "âŒ directorio scripts faltante" && exit 1)
      - echo "ğŸ§ª Ejecutando pruebas (si existen)"
      - npm test --if-present
      
  build:
    commands:
      - echo "ğŸ”¨ Iniciando fase de construcciÃ³n..."
      - echo "ğŸ“ Ejecutando lint (si estÃ¡ configurado)"
      - npm run lint --if-present || echo "Lint no configurado, continuando..."
      - echo "ğŸ—ï¸ Ejecutando build del proyecto"
      - npm run build --if-present || echo "Build script no encontrado, continuando..."
      - echo "âœ… Build completado exitosamente"
      
  post_build:
    commands:
      - echo "ğŸ¯ Ejecutando tareas post-build..."
      - echo "ğŸ“Š Generando reporte de dependencias"
      - npm list --depth=0 || true
      - echo "ğŸ” Verificando permisos de scripts"
      - chmod +x scripts/*.sh
      - echo "ğŸ“‹ Listando archivos finales"
      - find . -type f -name "*.js" -o -name "*.json" -o -name "*.yml" -o -name "*.sh" | head -20
      - echo "âœ… Post-build completado"

artifacts:
  files:
    - '**/*'
  exclude-paths:
    - node_modules/**/*
    - .git/**/*
    - .vscode/**/*
    - .idea/**/*
    - '*.log'
    - '.env*'
  name: datavision-app-$(date +%Y-%m-%d-%H-%M-%S)

cache:
  paths:
    - 'node_modules/**/*'

# Variables de entorno para el build
env:
  variables:
    NODE_ENV: production
    CI: true
  # parameter-store:
  #   - DB_PASSWORD: /datavision/db/password
  # secrets-manager:
  #   - API_KEY: prod/datavision/api-key

# Reportes y mÃ©tricas
reports:
  jest_reports:
    files:
      - 'coverage/lcov.info'
    base-directory: 'coverage'
    file-format: 'CLOVERXML'
  # eslint_reports:
  #   files:
  #     - 'eslint-report.xml'
  #   file-format: 'JUNITXML'